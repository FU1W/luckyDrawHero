"use strict";const path=require("path"),fs=require("fs");require("fix-path")(),module.paths.push(path.join("node_modules"));const{pbjs:pbjs,pbts:pbts}=require("protobufjs/cli"),pkg=require(join("package.json")),Vue=require(join("panel/vue.min.js")),cp=join("config.json");fs.existsSync(cp)||fs.writeFileSync(cp,JSON.stringify({input:null,output:null},null,4));let vm,panel,running,cache=require(cp);function join(t){return path.join(__dirname,"../",t)}async function openDir(t){const e=await Editor.Dialog.select({defaultPath:t,type:"directory"});return Array.isArray(e)?e[0]:e.filePaths?e.filePaths[0]:null}function dbPath(t){return/^db/.test(t)?t:"db:/"+t.slice(Editor.Project.path.length).replace(/\\/g,"/")}function protoRead(t,e,o){const r=fs.readdirSync(e);for(let n=0;n<r.length;n++){const i=path.join(e,r[n]);fs.statSync(path.join(e,r[n])).isDirectory()?protoRead(t,i,o):t.test(i)&&o.push(i)}}function protoCompile(t,e){return new Promise((o,r)=>{pbjs.main(["--force-number","-t","static","-r","creator","-w","commonjs"].concat(t),(t,n)=>{if(t)return r(t);write(e,n.replace(/\$protobuf/g,"protobuf").replace("protobuf.roots.creator = {}","protobuf.roots.creator = $util.global"),o)})})}function createTsd(t){return new Promise((e,o)=>{const r=t.replace(".js",".d.ts");process.execPath="node",pbts.main(["-m",t],(t,n)=>{if(t)return o(t);write(r,`declare global {\n${n}}\nexport {}`,e)})})}function copyProtobufjs(t){return new Promise((e,o)=>{const r=`${t}/protobuf.min.js`;fs.access(r,fs.constants.F_OK,o=>{if(o){const o=fs.readFileSync(join("node_modules/protobufjs/dist/minimal/protobuf.min.js"));write(r,o,o=>{const r=fs.readFileSync(join("node_modules/protobufjs/index.d.ts"));write(`${t}/protobuf.d.ts`,r,t=>e(o))})}})})}async function write(t,e,o){const r=dbPath(t);let n;fs.existsSync(t)?(n=await Editor.Message.request("asset-db","query-uuid",r),await Editor.Message.request("asset-db","save-asset",n,e)):n=await Editor.Message.request("asset-db","create-asset",r,e),o(n)}Editor.T=Editor.I18n.t,Editor.warn=console.warn,Editor.log=console.log,Editor.error=console.error,exports.style=fs.readFileSync(join("panel/index.css"),"utf8"),exports.template=fs.readFileSync(join("panel/index.html"),"utf8"),exports.$={root:"#r"},exports.close=function(){if(!vm)return;let t=!1;for(const e in cache)Object.hasOwnProperty.call(vm.$data,e)&&(cache[e]=vm.$data[e],t=!0);t&&fs.writeFileSync(cp,JSON.stringify(cache,null,4))},exports.ready=function(){vm=new Vue({el:(panel=this).$.root,data:{input:cache.input||path.join(Editor.Project.path,"assets"),output:cache.output||path.join(Editor.Project.path,"assets")},methods:{t:t=>Editor.T(`${pkg.name}.${t}`),async select_output(){const t=await openDir(Editor.Project.path);if(!t)return Editor.warn("选择路径错误");this.output=t.replace(Editor.Project.path,"")},async select_input(){const t=await openDir(Editor.Project.path);if(!t)return Editor.warn("选择路径错误");this.input=t.replace(Editor.Project.path,"")},execute(){if(running)return Editor.warn("正在生成中");if(""===this.output)return Editor.warn("先导入Protobuf.js库文件");var t=path.join(Editor.Project.path,this.input),e=path.join(Editor.Project.path,this.output);copyProtobufjs(e).then(()=>Editor.log("拷贝Protobuf.js库完成")).catch(t=>Editor.error(t)).finally(()=>running=!1);let o=["--no-beautify","--no-create","--no-convert","--no-verify","--no-delimited"];protoRead(new RegExp("\\.proto$"),t,o);const r=path.join(e,"protobuf_custom.js");this.compile(o,r)},compile(t,e){var o=path.join(Editor.Project.path,this.output);if(running=!0,e=e.replace(/\+/g,""),!/\.proto$/.test(t[t.length-1]))return[e,e.replace(".js",".d.ts")].forEach(t=>{fs.unlinkSync(t)}),running=!1,Editor.warn(`【${o}】文件夹中没找到Proto文件`);protoCompile(t,e).then(createTsd(e)).then(()=>Editor.log("生成协议代码完成")).catch(t=>Editor.error(t.message)).finally(()=>running=!1)}}})};